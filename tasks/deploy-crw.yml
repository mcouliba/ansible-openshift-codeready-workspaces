---
- name: get ConfigMap
  set_fact: 
    config_content: "{{ lookup('template', 'crw-config.yaml.j2') }} "

- name: create ConfigMap
  shell: "echo {{ config_content | quote }} | oc create -f -"
  register: res_cmd
  changed_when: res_cmd.rc == 0
  
- name: check if {{ operator_pod_name }} pod exists
  command: "oc get pod {{ operator_pod_name }}"
  register: cmd_result
  ignore_errors: true

- name: delete {{ operator_pod_name }} pod
  command: "oc delete pod {{ operator_pod_name }}"
  register: res_cmd
  changed_when: res_cmd.rc == 0
  when: cmd_result is success

- name: Deploy CodeReady Workspaces
  command: >
        oc run "{{ operator_pod_name }}"
        -i
        --restart=Never
        --serviceaccount={{ operator_service_account_name }}
        --image "{{ operator_image_name }}:{{ operator_image_tag }}"
        --overrides='{
                      "spec": {
                        "containers": [ 
                          { 
                            "image": "{{ operator_image_name }}:{{ operator_image_tag }}"
                            , "name": "che-operator"
                            , "imagePullPolicy":"IfNotPresent"
                            ,"envFrom":[
                              { 
                                "configMapRef": { 
                                  "name": "che-operator"
                                }
                              }]
                          }]
                      }
                    }'
  register: res_cmd
  changed_when: res_cmd.rc == 0
